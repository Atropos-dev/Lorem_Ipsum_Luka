{% comment %}
  This block is intended to be rendered in buy-buttons.liquid of Horizon theme.
  Usage:
    {% content_for "block", id: "skio-plan-picker", type: "_skio-plan-picker", product_form_id: product_form_id %}
{% endcomment %}
{% liquid
  comment
    -----------------------------
    Safe setup / fallbacks
    -----------------------------
  endcomment

  assign debug = false
  if request.design_mode
    assign debug = true
  endif

  assign has_block = false
  if block != blank
    assign has_block = true
  endif

  assign settings_obj = blank
  if has_block and block.settings != blank
    assign settings_obj = block.settings
  endif

  assign product_obj = product | default: closest.product | default: section.settings.product
  assign has_product = false
  if product_obj != blank
    assign has_product = true
  endif

  comment
    Product form id resolution:
    - keep existing product_form_id if provided
    - else try block setting
  endcomment
  assign resolved_form_id = product_form_id
  if resolved_form_id == blank and settings_obj != blank
    assign resolved_form_id = settings_obj.product_form_id
  endif

  comment
    Element name fallback (avoid invalid tag)
  endcomment
  assign element_name = 'skio-plan-picker'
  if settings_obj != blank and settings_obj.element_name != blank
    assign element_name = settings_obj.element_name
  endif

  comment
    Determine SKIO selling plan groups safely
  endcomment
  assign skio_selling_plan_groups = blank
  assign skio_group_count = 0
  if has_product and product_obj.selling_plan_groups != blank
    assign skio_selling_plan_groups = product_obj.selling_plan_groups | where: 'app_id', 'SKIO'
    assign skio_group_count = skio_selling_plan_groups.size
  endif

  comment
    Determine whether to render
    - if product_handle is set: render (assumes component will fetch product)
    - else: require product JSON + available + SKIO groups
  endcomment
  assign has_product_handle = false
  if settings_obj != blank and settings_obj.product_handle != blank
    assign has_product_handle = true
  endif

  assign skio_render = false
  if has_product_handle
    assign skio_render = true
  elsif has_product and product_obj.available and skio_group_count > 0
    assign skio_render = true
  endif

  comment
    Build a debug reason string (shown only when not rendering)
  endcomment
  assign debug_reason = ''
  if skio_render == false
    if has_block == false
      assign debug_reason = debug_reason | append: 'Missing block. '
    elsif settings_obj == blank
      assign debug_reason = debug_reason | append: 'Missing block.settings. '
    endif

    if has_product == false and has_product_handle == false
      assign debug_reason = debug_reason | append: 'No product available and no product_handle set. '
    endif

    if has_product and product_obj.available == false and has_product_handle == false
      assign debug_reason = debug_reason | append: 'Product not available. '
    endif

    if has_product and skio_group_count == 0 and has_product_handle == false
      assign debug_reason = debug_reason | append: 'No SKIO selling plan groups on product. '
    endif

    if resolved_form_id == blank
      assign debug_reason = debug_reason | append: 'Missing form id (product_form_id / block.settings.product_form_id). '
    endif
  endif
%}

{% if skio_render %}
  <style>
    skio-plan-picker {
      --skio-group-border-radius: {{ settings_obj.group_border_radius }}px;
      --skio-group-border-width: {{ settings_obj.group_border_width }}px;
      --skio-group-border-color: {{ settings_obj.group_border_color }};
      --skio-group-border-selected-color: {{ settings_obj.group_border_selected_color }};
      --skio-group-background-color: {{ settings_obj.group_background_color }};
      --skio-group-background-selected-color: {{ settings_obj.selected_group_background_color }};
      --skio-group-text-color: {{ settings_obj.group_text_color }};
      --skio-group-text-selected-color: {{ settings_obj.group_selected_text_color }};
      --skio-discount-color: {{ settings_obj.discount_color }};
      --skio-discount-text-color: {{ settings_obj.discount_text_color }};
      --skio-button-plan-selector-width: {{ settings_obj.button_plan_selector_width }};
      --skio-tooltip-background-color: {{ settings_obj.tooltip_background_color }};
      --skio-tooltip-text-color: {{ settings_obj.tooltip_text_color }};
    }
    skio-plan-picker {
      display: none
    }
    skio-plan-picker:first-of-type {
      display: contents;
    }
    .shopify-block:has(skio-plan-picker) {
      width: 100%;
    }    
  </style>

  <{{ element_name }}
    key='{{ block.id }}'
    options='{{ settings_obj | json | escape }}'
    layout='{{ settings_obj.layout }}'
    formId='{{ resolved_form_id }}'
    {% if settings.currency_code_enabled %}
      moneyFormat='{{ shop.money_with_currency_format }}'
    {% else %}
      moneyFormat='{{ shop.money_format }}'
    {% endif %}
    {% if has_product_handle %}
      productHandle='{{ settings_obj.product_handle }}'
    {% else %}
      product='{{ product_obj | json | escape }}'
      selectedVariant='{{ product_obj.selected_or_first_available_variant | json | escape }}'
    {% endif %}
  >
    {%- comment -%}
      IMPORTANT: use the same form id you pass as formId above
    {%- endcomment -%}
    <input type='hidden' name='selling_plan' form='{{ resolved_form_id }}'>
  </{{ element_name }}>

  <script src='{{ "skio-plan-picker-component.js" | asset_url }}' type='module'></script>

{% else %}
  {% if debug %}
    <script>
      console.warn('[Skio Plan Picker] not rendered:', {{ debug_reason | json }});
      console.info('[Skio Plan Picker] diagnostics', {
        hasBlock: {{ has_block | json }},
        hasProduct: {{ has_product | json }},
        hasProductHandle: {{ has_product_handle | json }},
        skioGroupCount: {{ skio_group_count | json }},
        productAvailable: {{ has_product | json }} ? {{ product_obj.available | json }} : null,
        resolvedFormId: {{ resolved_form_id | json }}
      });
    </script>
  {% endif %}
{% endif %}{% if skio_render %}
  <style>
    skio-plan-picker {
      --skio-group-border-radius: {{ block.settings.group_border_radius }}px;
      --skio-group-border-width: {{ block.settings.group_border_width }}px;
      --skio-group-border-color: {{ block.settings.group_border_color }};
      --skio-group-border-selected-color: {{ block.settings.group_border_selected_color }};
      --skio-group-background-color: {{ block.settings.group_background_color }};
      --skio-group-background-selected-color: {{ block.settings.selected_group_background_color }};
      --skio-group-text-color: {{ block.settings.group_text_color }};
      --skio-group-text-selected-color: {{ block.settings.group_selected_text_color }};
      --skio-discount-color: {{ block.settings.discount_color }};
      --skio-discount-text-color: {{ block.settings.discount_text_color }};
      --skio-button-plan-selector-width: {{ block.settings.button_plan_selector_width }};
      --skio-tooltip-background-color: {{ block.settings.tooltip_background_color }};
      --skio-tooltip-text-color: {{ block.settings.tooltip_text_color }};
    }
  </style>

  <{{ block.settings.element_name }}
    key='{{ block.id }}'
    options='{{ block.settings | json | escape }}'
    layout='{{ block.settings.layout }}'
    formId='{{ product_form_id }}'

    {% if settings.currency_code_enabled %}
      moneyFormat='{{ shop.money_with_currency_format }}'
    {% else %}
      moneyFormat='{{ shop.money_format }}'
    {% endif %}

    {% if block.settings.product_handle != null %}
      productHandle='{{ block.settings.product_handle }}'
    {% else %}
      product='{{ product | json | escape }}'
      selectedVariant='{{ product.selected_or_first_available_variant | json | escape }}'
    {% endif %}
  >
    <input type='hidden' name='selling_plan' form='{{ block.settings.form_id }}'>
  </{{ block.settings.element_name }}>

  <script src='{{ 'skio-plan-picker-component.js' | asset_url }}' type='module'></script>
{% else %}
  <script>console.log('Skio Plan Picker not rendered');</script>
{% endif %}

{% schema %}
  {
    "name": "Skio Plan Picker",
    "settings": [
    {
      "type": "paragraph",
      "content": "[Integration Guide](https://integrate.skio.com)"
    },
    {
      "type": "liquid",
      "id": "external_price_selector",
      "label": "External Price Selector to update display price on plan change",
      "info": "This should match the ID or class of the price element. Set to the default for Dawn themes. Accepts liquid. For multiple items, separate each by a comma.",
      "default": ".price-item--regular"
    },
    {
      "type": "checkbox",
      "id": "show_details",
      "label": "Display \"How do subscriptions work?\" details element",
      "info": "Display \"How do subscriptions work?\" details element, with the default copy / display settings. Turn this off to use a custom details element.",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_without_subscription",
      "label": "Diplay widget without subscriptions",
      "info": "Display one time purchase if no subscriptions are available. This does not affect functionality.",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_compare_price",
      "label": "Show compare at price",
      "default": true
    },
    {
      "type": "header",
      "content": "Style settings",
      "info": "Customize the plan picker to match your site's feel"
    },
    {
      "type": "liquid",
      "id": "legend_content",
      "label": "Section title",
      "default": "Select subscription plan"
    },
    {
      "type": "checkbox",
      "id": "show_legend",
      "label": "Show section title",
      "default": false
    },
    {
      "type": "select",
      "id": "layout",
      "label": "Widget layout",
      "options": [
        {
          "value": "vertical",
          "label": "Vertical"
        },
        {
          "value": "horizontal",
          "label": "Horizontal"
        },
        {
          "value": "hidden",
          "label": "Hidden"
        }
      ],
      "default": "vertical"
    },
    {
      "type": "select",
      "id": "dropdownPosition",
      "label": "Frequency position",
      "options": [
        {
          "value": "inside",
          "label": "Inside group"
        },
        {
          "value": "underneath",
          "label": "Underneath group"
        },
        {
          "value": "hidden",
          "label": "Hidden"
        }
      ],
      "default": "inside"
    },
    {
      "type": "liquid",
      "id": "additional_frequency_label",
      "label": "Additional Frequency Label",
      "info": "Add additional label to be shown above the Frequency selector"
    },
    {
      "type": "checkbox",
      "id": "start_onetime",
      "label": "Default to one time purchase",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "onetime_first",
      "label": "Display one time purchase first",
      "default": true
    },
    {
      "type": "range",
      "id": "group_border_radius",
      "label": "Plan option border radius",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "default": 0
    },
    {
      "type": "range",
      "id": "group_border_width",
      "label": "Plan option border width",
      "min": 0,
      "max": 25,
      "step": 1,
      "unit": "px",
      "default": 2
    },
    {
      "type": "color",
      "id": "group_border_color",
      "label": "Plan option border color",
      "default": "#000"
    },
    {
      "type": "color",
      "id": "group_border_selected_color",
      "label": "Plan option selected border color",
      "default": "#000"
    },
    {
      "type": "color",
      "id": "group_background_color",
      "label": "Plan option background color",
      "default": "transparent"
    },
    {
      "type": "color",
      "id": "selected_group_background_color",
      "label": "Plan option selected background color",
      "default": "transparent"
    },
    {
      "type": "color",
      "id": "group_text_color",
      "label": "Plan option text color",
      "default": "#000"
    },
    {
      "type": "color",
      "id": "group_selected_text_color",
      "label": "Plan option selected text color",
      "default": "#000"
    },
    {
      "type": "checkbox",
      "id": "show_radio_selector",
      "label": "Show radio selector",
      "default": true
    },
    {
      "type": "text",
      "id": "onetime_title",
      "label": "One time purchase title",
      "default": "One time purchase"
    },
    {
      "type": "text",
      "id": "subscription_title",
      "label": "Subscription title",
      "default": "Subscribe"
    },
    {
      "type": "text",
      "id": "prepaid_title",
      "label": "Prepaid title",
      "default": "Prepaid"
    },
    {
      "type": "radio",
      "id": "discount_format",
      "label": "Displayed Discount Format",
      "options": [
        {
          "value": "percent",
          "label": "Percent"
        },
        {
          "value": "absolute",
          "label": "Absolute"
        }
      ],
      "default": "percent"
    },
    {
      "type": "radio",
      "id": "discount_style",
      "label": "Discount Style",
      "options": [
        {
          "value": "bubble",
          "label": "Bubble"
        },
        {
          "value": "text",
          "label": "Text"
        }
      ],
      "default": "bubble"
    },
    {
      "type": "liquid",
      "id": "discount_text",
      "label": "Discount text",
      "default": "Save [discount]",
      "info": "Use [discount] to display the discount amount. Can also use [future_price_adjustments] to display future price adjustments from the field below"
    },
    {
      "type": "color",
      "id": "discount_color",
      "label": "Discount Background Color",
      "default": "#0fa573"
    },
    {
      "type": "color",
      "id": "discount_text_color",
      "label": "Discount Text Color",
      "default": "#fff"
    },
    {
      "type": "liquid",
      "id": "additional_subscription_content",
      "label": "Additional Subscription Content",
      "info": "Add additional information to be displayed under Subscription options. Works with HTML. Accepts [discount] and [future_price_adjustments] to display the discount and future price adjustments respectively."
    },
    {
      "type": "select",
      "id": "selector_type",
      "label": "Interval selector type",
      "options": [
        {
          "value": "hidden",
          "label": "Hidden"
        },
        {
          "value": "dropdown",
          "label": "Dropdown"
        },
        {
          "value": "button",
          "label": "Button"
        }
      ],
      "default": "dropdown"
    },
    {
      "type": "range",
      "id": "button_plan_selector_width",
      "label": "Button plan selector width",
      "min": 20,
      "max": 200,
      "step": 2,
      "unit": "px",
      "default": 100
    },
    {
      "type": "header",
      "content": "Tooltip Settings"
    },
    {
      "type": "checkbox",
      "id": "show_tooltip",
      "label": "Show tooltip",
      "default": false
    },
    {
      "type": "liquid",
      "id": "tooltip_content",
      "label": "Tooltip content",
      "info": "Add the content you want to display in the tooltip. Accepts Liquid. Use [discount] to display the current selling plan's discount.  Use [future_price_adjustments] to display the future price adjustment text in the setting below."
    },
    {
      "type": "color",
      "id": "tooltip_background_color",
      "label": "Tooltip background color",
      "default": "#333"
    },
    {
      "type": "color",
      "id": "tooltip_text_color",
      "label": "Tooltip text color",
      "default": "#fff"
    },
    {
      "type": "header",
      "content": "Configuration Settings",
      "info": "Customize the functionality of the skio plan picker"
    },
    {
      "type": "text",
      "id": "default_subscription",
      "label": "Default selected subscription",
      "info": "Enter the name of the subscription you want to be selected by default. Leave blank to select the first subscription. (e.g. '3 months')"
    },
    {
      "type": "liquid",
      "id": "future_price_adjustments_text",
      "label": "Future price adjustment text",
      "info": "Edit the text you want to display for future price adjustments. You can use [discount] and [order_count] or [order_count_ordinal] to display the discount and order count respectively. (e.g. 'Then save [discount] after order [order_count]')",
      "default": "<small>Then [discount] off after the [order_count_ordinal] order</small>"
    },
    {
      "type": "header",
      "content": "Advanced Settings",
      "info": "Only use the following features if you are a developer"
    },
    {
      "type": "text",
      "id": "element_name",
      "label": "Element Name",
      "info": "Create an element using a different name, useful when creating extensions",
      "default": "skio-plan-picker"
    },
    {
      "type": "product",
      "id": "product_handle",
      "label": "Product",
      "info": "Useful on landing pages, on product pages the product is automatically detected"
    },
    {
      "type": "checkbox",
      "id": "combine_groups",
      "label": "Combine Groups",
      "info": "Display all plans in one group",
      "default": false
    },
    {
      "type": "text",
      "id": "combined_group_name",
      "label": "Combined Group Name",
      "info": "Name of the combined group. (display only)",
      "default": "Subscription"
    }]
  }
{% endschema %}