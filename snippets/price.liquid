{%- doc -%}
  This snippet is used to render a product card.
  It is used in the product block,featured product block, and the product card block.

  @param {product} product_resource - The product to render
  @param {boolean} [show_unit_price] - Whether to show the unit price
  @param {boolean} [show_sale_price_first] - Whether to show the sale price first
  @param {boolean} [show_discount_badge] - Renders 'Save' tag if the product matches the condition (optional)
{%- enddoc -%}

{%- liquid
  assign show_unit_price = show_unit_price | default: false
  assign show_sale_price_first = show_sale_price_first | default: false
  assign selected_variant = product_resource.selected_or_first_available_variant
  assign price = selected_variant.price
  assign compare_at_price = selected_variant.compare_at_price
  assign show_discount_badge = show_discount_badge | default: false

  assign show_compare_price = false
  if compare_at_price > price
    assign show_compare_price = true
  endif

  if product_resource == blank
    assign price = 1999
  endif

  assign discount_percentage = 0
    assign discount_percentage_all = 0
    assign discount_percent = 0
    if customer and settings.global_discounts != blank
        for global_discount in settings.global_discounts
        if discount_percentage == 0
            assign enable_conditions = global_discount.enable_conditions.value
            assign disable_conditions = global_discount.disable_conditions.value
            assign metafields_namespace = global_discount.metafields_namespace
            assign metafields_key = global_discount.metafields_key

            assign enable_values = ''
            assign disable_values = ''

            for enable_condition in enable_conditions
            if forloop.first
                assign enable_values = enable_condition.label
            else
                assign enable_values = enable_values | append: ',' | append: enable_condition.label
            endif
            endfor

            assign enable_values = enable_values | split: ','

            for disable_condition in disable_conditions
            if forloop.first
                assign disable_values = disable_condition.label
            else
                assign disable_values = disable_values | append: ',' | append: disable_condition.label
            endif
            endfor

            assign disable_values = disable_values | split: ','

            if enable_values contains customer.metafields[metafields_namespace][metafields_key]
            unless disable_values contains customer.metafields[metafields_namespace][metafields_key]
                assign discount_percentage = global_discount.discount_percentage.value | default: 0
            endunless
            endif

            if enable_values.size == 0
            unless disable_values contains customer.metafields[metafields_namespace][metafields_key]
                assign discount_percentage_all = global_discount.discount_percentage.value | default: 0
            endunless
            endif
        endif
        endfor

        if discount_percentage == 0 and discount_percentage_all > 0
        assign discount_percentage = discount_percentage_all
        endif

        if discount_percentage > 0
        assign compare_at_price = price
        assign discount_percentage = 100 | minus: discount_percentage | divided_by: 100.0
        assign discount_price = compare_at_price | times: discount_percentage
        assign price = discount_price
        assign show_compare_price = true
        assign saving_price = compare_at_price | minus: price
        assign discount_percent = saving_price | times: 100 | divided_by: compare_at_price | ceil
        endif

    endif

    # Apply dev-only global discount if enabled and no other discount applied
    if discount_percentage == 0 and settings.dev_global_discount_enabled
        assign dev_percent = settings.dev_global_discount_percent | default: 0
        if dev_percent > 0 and compare_at_price <= price
        assign compare_at_price = price
        assign discount_percentage = 100 | minus: dev_percent | divided_by: 100.0
        assign discount_price = compare_at_price | times: discount_percentage
        assign price = discount_price
        assign show_compare_price = true
        assign saving_price = compare_at_price | minus: price
        assign discount_percent = saving_price | times: 100 | divided_by: compare_at_price | ceil
        endif
    endif

  # Checks if product handle matches the closest product's handle (i.e. product page)
  # and if the currency code is enabled for product pages
  if product.handle == closest.product.handle and settings.currency_code_enabled_product_pages
    assign price = price | money_with_currency
    assign compare_at_price = compare_at_price | money_with_currency

    # Checks if product handle does not match the closest product's handle (i.e. product card)
    # and if the currency code is enabled for product cards
  elsif product.handle != closest.product.handle and settings.currency_code_enabled_product_cards
    assign price = price | money_with_currency
    assign compare_at_price = compare_at_price | money_with_currency

  else
    assign price = price | money
    assign compare_at_price = compare_at_price | money
  endif
-%}

<div ref="priceContainer">
  {% if show_sale_price_first == false and show_compare_price %}
    <span role="group">
      <span class="visually-hidden">{{ 'content.price_regular' | t }}&nbsp;</span>
      <span class="compare-at-price">{{- compare_at_price -}}</span>
    </span>
  {% endif %}

  {% if show_compare_price %}
    <span role="group">
      <span class="visually-hidden">{{ 'content.price_sale' | t }}&nbsp;</span>
      <span class="price">{{ price | default: '&nbsp;' }}</span>
    </span>
  {% else %}
    <span class="price">{{ price | default: '&nbsp;' }}</span>
  {% endif %}

  {% if show_sale_price_first == true and show_compare_price %}
    <span role="group">
      <span class="visually-hidden">{{ 'content.price_regular' | t }}&nbsp;</span>
      <span class="compare-at-price">{{- compare_at_price -}}</span>
    </span>
  {% endif %}
  {%- if selected_variant.unit_price and show_unit_price %}
    {%- liquid
      if product.handle == closest.product.handle and settings.currency_code_enabled_product_pages
        assign unit_price = selected_variant.unit_price | money_with_currency
      elsif product.handle != closest.product.handle and settings.currency_code_enabled_product_cards
        assign unit_price = selected_variant.unit_price | money_with_currency
      else
        assign unit_price = selected_variant.unit_price | money
      endif
    -%}
    {% render 'unit-price', price: unit_price, measurement: selected_variant.unit_price_measurement %}
  {%- endif -%}
  {% render 'product-discount-badge', selected_variant: selected_variant, show_discount_badge: show_discount_badge %}
</div>
