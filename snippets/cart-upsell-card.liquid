<slideshow-slide
  class="cart-upsell__card cart-upsell__slide"
  ref="slides[]"
  aria-hidden="{% if index == 0 %}false{% else %}true{% endif %}"
>
  {% liquid
    assign ratio = item.image.aspect_ratio
    assign border_opacity = settings.cart_thumbnail_border_opacity | divided_by: 100.0
    assign border_override = '--border-width: [cart_thumbnail_border_width]px; --border-style: [cart_thumbnail_border_style]; --border-color: rgb(var(--color-border-rgb) / [cart_thumbnail_border_opacity]); --border-radius: [cart_thumbnail_border_radius]px;' | replace: '[cart_thumbnail_border_width]', settings.cart_thumbnail_border_width | replace: '[cart_thumbnail_border_style]', settings.cart_thumbnail_border | replace: '[cart_thumbnail_border_opacity]', border_opacity | replace: '[cart_thumbnail_border_radius]', settings.cart_thumbnail_border_radius

    if settings.cart_thumbnail_border_radius > 0
      assign border_override = border_override | append: ' overflow: hidden;'
    endif
  %}
  <a
    href="{{ upsell_product.url }}"
    class="cart-items__media-container"
    style="--ratio:{{ ratio }};"
  >
    {%- liquid
      echo upsell_product.featured_image | image_url: width: 250 | image_tag: class: 'cart-items__media-image border-style', style: border_override
    -%}
  </a>
  <div class="cart-upsell__card-content">
    <p class="cart-upsell__card-title">{{ upsell_product.title }}</p>

    {%- assign product_form_id = 'CartUpsell-ProductForm-' | append: forloop.index0 -%}
    <product-form-component
      data-section-id="{{ section.id }}"
      data-product-id="{{ upsell_product.id }}"
      data-product-url="{{ upsell_product.url }}"
      on:submit="/handleSubmit"
      data-quantity-default="{% if upsell_product.selected_or_first_available_variant.quantity_rule.min %}{{ upsell_product.selected_or_first_available_variant.quantity_rule.min }}{% else %}1{% endif %}"
    >
      <div
        class="visually-hidden"
        aria-live="assertive"
        role="status"
        aria-atomic="true"
        ref="liveRegion"
      ></div>
      {%- form 'product', upsell_product, id: product_form_id, data-type: 'add-to-cart-form' -%}
        <input
          type="hidden"
          name="id"
          ref="variantId"
          value="{{ upsell_product.selected_or_first_available_variant.id }}"
        >
        <input
          type="hidden"
          name="quantity"
          value="1"
        >

        {%- assign variant = upsell_product.selected_or_first_available_variant -%}
        {% liquid
          assign product = upsell_product
          if request.visual_preview_mode and product == blank
            assign product = collections.all.products.first
          endif

          assign variant = upsell_product.selected_or_first_available_variant
          assign inventory_quantity = variant.inventory_quantity
          assign inventory_policy = variant.inventory_policy

          if variant.inventory_management == 'shopify'
            assign inventory_managed = true
          endif

          if variant.quantity_rule.min > variant.inventory_quantity and inventory_managed and inventory_policy == 'deny'
            assign quantity_rule_soldout = true
          endif

          assign variant_price = variant.price | money

          if inventory_managed
            if inventory_quantity <= 0 and inventory_policy == 'deny' or quantity_rule_soldout
              assign can_add_to_cart = false
              assign add_to_cart_text = 'products.product.sold_out' | t
            else
              assign can_add_to_cart = true
              assign add_to_cart_text = 'actions.cart_upsell_add_to_cart' | t: price: variant_price
            endif
          else
            if closest.product.selected_or_first_available_variant != null
              assign can_add_to_cart = true
              assign add_to_cart_text = 'actions.cart_upsell_add_to_cart' | t: price: variant_price
            else
              assign can_add_to_cart = false
              assign add_to_cart_text = 'products.product.unavailable' | t
            endif
          endif
        %}

        <span
          {{ block.shopify_attributes }}
          style="--add-to-cart-font-case: {{ settings.button_text_case }};"
        >
          <add-to-cart-component
            ref="addToCartButtonContainer"
            data-add-to-cart-animation="{{ settings.add_to_cart_animation }}"
          >
            <button
              type="submit"
              name="add"
              ref="addToCartButton"
              on:click="/handleClick"
              class="button"
              {% unless can_add_to_cart %}
                disabled
              {% endunless %}
            >
              {{ add_to_cart_text }}
            </button>
          </add-to-cart-component>
        </span>
      {%- endform -%}
    </product-form-component>
  </div>
</slideshow-slide>
